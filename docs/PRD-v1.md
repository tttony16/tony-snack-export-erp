# 零食出口贸易 ERP 系统 — 产品需求文档 (PRD)

> **版本**: v1.2
> **日期**: 2026-02-28
> **阶段**: 第一期（MVP + 排柜管理 + 出库管理）

---

## 一、产品概述

### 1.1 产品定位

一套面向零食出口贸易公司的轻量级 ERP 系统，覆盖从**海外客户下单**到**装柜出口**的全流程管理。系统以销售订单为驱动核心，实现"以销定采、按单集货、按柜出运"的业务闭环。

### 1.2 目标用户

- 公司业务员（接单、报价、跟单）
- 采购人员（供应商对接、下采购单）
- 仓库人员（收货、验货、装柜）
- 管理层（业务全局把控、数据查看）

### 1.3 核心业务流程

```
客户下单 → 创建销售订单
    → 生成采购需求 → 供应商采购 → 到货收货验货
    → 按订单集货 → 排柜规划 → 装柜出库
    → 报关出运（手工处理）→ 客户收货付尾款
```

### 1.4 第一期范围

| 包含 | 不包含（后续迭代） | 不含原因 |
|------|-------------------|---------|
| 销售订单管理 | PI（形式发票）管理 | 第一期先跑通核心流程，报价环节后续补充 |
| 采购管理（以销定采） | 完整财务模块（多币种核算、出口退税） | 财务合规复杂，先用手工+Excel |
| 轻量仓储管理（收货、验货、集货） | 报关单证自动化（报关单、原产地证生成） | 报关流程依赖"单一窗口"，合规成本高 |
| 排柜管理（自建配载计算 + 业务层） | 合规管理（目的国法规引擎） | 需要大量法规数据积累 |
| 基础物流跟踪（船期、状态） | 追溯查询系统 | 第一期数据量不足以支撑 |
| 商品中心（SKU 管理） | 数据报表与 BI | 先跑通流程再做分析 |
| 客户与供应商管理 | 客户自助查询门户 | 优先级低 |

---

## 二、模块详细设计

---

### 模块 1：商品中心

#### 2.1.1 功能说明

管理所有零食商品的基础信息，是其他模块的数据基础。

#### 2.1.2 数据字段

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| SKU 编码 | 字符串 | 是 | 系统自动生成或手动输入，唯一标识 |
| 商品名称（中文） | 字符串 | 是 | |
| 商品名称（英文） | 字符串 | 是 | 用于出口单证 |
| 品类 | 三级品类 | 是 | 三级层级结构（一级品类→二级品类→三级品类），创建商品时必须选到三级品类。一级品类如：膨化食品、糖果、饼干、坚果、饮料、调味品、方便食品、肉类零食、果干蜜饯、乳制品、其他 |
| 品牌 | 字符串 | 否 | |
| 商品条码 | 字符串 | 否 | 商品包装上的条形码/二维码编号（如 EAN-13、UPC），用于扫码识别商品 |
| 规格 | 字符串 | 是 | 如："500g/袋"、"12瓶/箱" |
| 单件重量（kg） | 数值 | 是 | 含包装的单件毛重 |
| 单件体积（CBM） | 数值 | 是 | 含包装的单件体积，用于排柜计算 |
| 装箱规格 | 字符串 | 是 | 外箱包装方式，如 "24袋/箱" |
| 外箱尺寸（cm） | 长×宽×高 | 是 | 用于排柜计算 |
| 外箱毛重（kg） | 数值 | 是 | 用于排柜计算 |
| 保质期（天） | 数值 | 是 | |
| 默认采购价（RMB） | 数值 | 否 | 参考价，实际以采购单为准 |
| 默认供应商 | 关联 | 否 | 关联供应商档案 |
| HS 编码 | 字符串 | 否 | 海关商品编码，用于报关 |
| 图片 | 文件 | 否 | 商品图片 |
| 状态 | 枚举 | 是 | 启用 / 停用 |
| 备注 | 文本 | 否 | |

#### 2.1.3 功能点

- **商品列表**：支持按品类（三级联动筛选，可选任意层级）、品牌（下拉选择）、状态筛选，支持关键词搜索（SKU / 名称）
- **新增/编辑商品**：录入上述字段信息，品类通过三级联动选择器（Cascader）选择，必须选到三级品类
- **导入导出**：支持 Excel 批量导入商品数据（品类按名称匹配），支持导出（品类显示为"一级 / 二级 / 三级"格式）
- **停用商品**：软删除，已关联历史订单的商品不可物理删除

#### 2.1.4 品类管理

系统支持三级品类体系管理，品类数据存储在 `product_categories` 表中，采用单表自引用模型（`parent_id` + `level` 字段）。

**品类管理功能**（位于"系统管理 > 品类管理"菜单下）：
- **品类树展示**：以树形结构展示所有品类层级
- **新增品类**：可在任意品类下添加子品类，最多三级
- **编辑品类**：修改品类名称、排序
- **删除品类**：删除品类时检查是否有关联商品，有则禁止删除
- **同级唯一性**：同一父品类下品类名称不可重复

**品类管理权限**：仅超级管理员（`system:config` 权限）可管理品类。

**预置一级品类**：膨化食品、糖果、饼干、坚果、饮料、调味品、方便食品、肉类零食、果干蜜饯、乳制品、其他。管理员可在此基础上自行添加二级、三级品类。

---

### 模块 2：客户管理

#### 2.2.1 功能说明

管理海外客户信息，是销售订单的关联基础。

#### 2.2.2 数据字段

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| 客户编码 | 字符串 | 是 | 系统自动生成 |
| 客户名称 | 字符串 | 是 | 公司全称 |
| 客户简称 | 字符串 | 否 | 日常使用 |
| 国家/地区 | 枚举 | 是 | |
| 详细地址 | 字符串 | 否 | |
| 联系人 | 字符串 | 是 | |
| 联系电话 | 字符串 | 否 | |
| 邮箱 | 字符串 | 否 | |
| 结算币种 | 枚举 | 是 | USD / EUR / JPY / GBP / THB（泰铢）/ VND（越南盾）/ MYR（林吉特）/ SGD（新加坡元）/ PHP（比索）/ IDR（卢比）/ 其他 |
| 付款方式 | 枚举 | 是 | T/T（电汇）/ L/C（信用证）/ D/P / D/A |
| 付款条件 | 字符串 | 否 | 如 "30% 定金 + 70% 见提单副本付款" |
| 贸易术语 | 枚举 | 否 | FOB / CIF / CFR / EXW 等 |
| 备注 | 文本 | 否 | |

#### 2.2.3 功能点

- 客户列表：按国家/地区筛选，搜索
- 新增/编辑客户
- 客户详情页：查看该客户的所有历史订单

---

### 模块 3：供应商管理

#### 2.3.1 功能说明

管理国内零食供应商信息。

#### 2.3.2 数据字段

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| 供应商编码 | 字符串 | 是 | 系统自动生成 |
| 供应商名称 | 字符串 | 是 | |
| 联系人 | 字符串 | 是 | |
| 联系电话 | 字符串 | 是 | |
| 地址 | 字符串 | 否 | |
| 供应品类 | 多选（一级品类） | 否 | 该供应商主要供应的商品品类，从一级品类中选择 |
| 供应品牌 | 多选 | 否 | 该供应商供应的品牌列表，如 "乐事、旺旺、良品铺子" |
| 供应商品 | 关联（多个） | 否 | 关联商品中心，明确该供应商能供应哪些具体 SKU |
| 账期 | 字符串 | 否 | 如 "月结30天"、"货到付款" |
| 营业执照编号 | 字符串 | 否 | |
| 食品生产许可证（SC） | 字符串 | 否 | |
| 资质证书附件 | 文件列表 | 否 | 上传营业执照、SC 证书等扫描件 |
| 备注 | 文本 | 否 | |

#### 2.3.3 功能点

- 供应商列表：搜索、筛选
- 新增/编辑供应商
- 供应商详情页：查看关联的采购单历史

---

### 模块 4：销售订单管理

#### 2.4.1 功能说明

系统的核心驱动。后续所有环节（采购、入库、排柜、出运）均围绕销售订单展开。

#### 2.4.2 销售订单状态流转

```
新建 → 已确认 → 采购中 → 已到齐(货物全部入库) → 已排柜 → 已装柜 → 已出运 → 已签收 → 已完成
                                                                              ↘ 异常
```

#### 2.4.3 销售订单数据字段

**订单头信息：**

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| 订单编号 | 字符串 | 是 | 系统自动生成，格式如 SO-20260226-001 |
| 客户 | 关联 | 是 | 关联客户档案 |
| 订单日期 | 日期 | 是 | |
| 要求交货日期 | 日期 | 否 | 客户要求的最晚交货日期 |
| 目的港 | 字符串 | 是 | 如 "Manila, Philippines" |
| 贸易术语 | 枚举 | 是 | FOB / CIF / CFR |
| 结算币种 | 枚举 | 是 | 默认取客户的结算币种 |
| 付款方式 | 枚举 | 是 | 默认取客户的付款方式 |
| 付款条件 | 字符串 | 否 | |
| 订单状态 | 枚举 | 是 | 见状态流转图 |
| 备注 | 文本 | 否 | |

**订单明细行（商品列表）：**

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| 商品 | 关联 | 是 | 关联商品中心 SKU |
| 数量 | 数值 | 是 | 销售数量（按件/箱） |
| 单位 | 枚举 | 是 | 件 / 箱 |
| 单价（外币） | 数值 | 是 | |
| 金额（外币） | 数值 | 自动 | 数量 × 单价 |
| 已采购数量 | 数值 | 自动 | 系统根据采购单自动统计 |
| 已入库数量 | 数值 | 自动 | 系统根据入库记录自动统计 |

**订单汇总（自动计算）：**

| 字段 | 说明 |
|------|------|
| 订单总金额（外币） | 所有明细行金额之和 |
| 总件数/箱数 | 所有明细行数量之和 |
| 预估总体积（CBM） | 根据商品体积数据自动计算 |
| 预估总重量（KG） | 根据商品重量数据自动计算 |
| 采购完成率 | 已采购数量 / 订单数量 × 100% |
| 到货完成率 | 已入库数量 / 订单数量 × 100% |

#### 2.4.4 功能点

- **创建订单**：选择客户后自动填充默认币种、付款方式等；添加商品明细行
- **订单列表**：按状态、客户、日期范围筛选；显示关键进度指标（采购完成率、到货完成率）
- **编辑订单**：仅"新建"和"已确认"状态可编辑明细
- **确认订单**：将状态从"新建"改为"已确认"，触发可以开始采购
- **一键生成采购需求**：根据订单明细自动生成采购单草稿（详见采购模块）
- **订单详情页**：展示订单信息 + 关联的采购单列表 + 入库记录 + 排柜信息 + 物流信息，实现"一单看全程"
- **订单进度看板**：全局视图，按状态分组展示所有在途订单

---

### 模块 5：采购管理

#### 2.5.1 功能说明

向国内供应商采购零食商品。采购单可以从销售订单生成（以销定采），也可以独立创建（如提前备货、补货等场景），不强制关联销售订单。

#### 2.5.2 采购单状态流转

```
草稿 → 已下单 → 部分到货 → 全部到货 → 已完成
                                        ↘ 已取消
```

#### 2.5.3 采购单数据字段

**采购单头信息：**

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| 采购单编号 | 字符串 | 是 | 系统自动生成，格式如 PO-20260226-001 |
| 关联销售订单 | 关联（多个） | 否 | 可选关联，标记该采购单为哪些销售订单采购；独立采购时留空 |
| 供应商 | 关联 | 是 | |
| 采购日期 | 日期 | 是 | |
| 要求到货日期 | 日期 | 否 | |
| 采购单状态 | 枚举 | 是 | |
| 合计金额（RMB） | 数值 | 自动 | |
| 备注 | 文本 | 否 | |

**采购单明细行：**

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| 商品 | 关联 | 是 | |
| 关联销售订单行 | 关联 | 否 | 可选关联，明确这行货是为哪个销售订单采购的 |
| 采购数量 | 数值 | 是 | |
| 单位 | 枚举 | 是 | |
| 采购单价（RMB） | 数值 | 是 | |
| 金额（RMB） | 数值 | 自动 | |
| 已到货数量 | 数值 | 自动 | 系统根据入库记录统计 |

#### 2.5.4 功能点

- **从销售订单生成采购单**：选择一个或多个已确认的销售订单，系统自动汇总商品需求，按默认供应商分组生成采购单草稿。用户可手动调整供应商、价格和数量
- **独立创建采购单**：不关联销售订单，直接选择供应商和商品进行采购（适用于提前备货、补货等场景）
- **采购单列表**：按状态、供应商、日期筛选；支持按"已关联订单/未关联订单"筛选
- **编辑采购单**：草稿状态可自由编辑
- **下单确认**：将采购单从"草稿"改为"已下单"
- **后续关联**：独立创建的采购单，后续可以补充关联到销售订单
- **采购单详情页**：展示关联的销售订单（如有）、入库记录

---

### 模块 6：仓储管理（轻量版）

#### 2.6.1 功能说明

管理货物从供应商到货到装柜出库的中转过程。本模块定位为**集货中转管理**，不涉及复杂的库位管理和长期仓储策略。

#### 2.6.2 核心流程

```
供应商送货到仓 → 创建收货单（关联采购单）→ 验货 → 验货通过入库 → 按销售订单集货 → 装柜出库
```

#### 2.6.3 收货验货单

**单据字段：**

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| 收货单编号 | 字符串 | 是 | 系统自动生成 |
| 关联采购单 | 关联 | 是 | |
| 收货日期 | 日期 | 是 | |
| 收货人 | 字符串 | 是 | |

**收货明细行：**

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| 商品 | 关联 | 是 | 从采购单带入 |
| 应收数量 | 数值 | 自动 | 采购单数量 - 已到货数量 |
| 实收数量 | 数值 | 是 | 实际清点数量 |
| 验货结果 | 枚举 | 是 | 合格 / 不合格 / 部分合格 |
| 不合格数量 | 数值 | 条件必填 | 验货结果非"合格"时必填 |
| 不合格原因 | 文本 | 条件必填 | 如：包装破损、数量短缺、产品变质等 |
| 生产日期 | 日期 | 是 | 记录该批次的生产日期 |
| 批次号 | 字符串 | 自动 | 系统根据收货日期+采购单自动生成 |
| 备注 | 文本 | 否 | |

#### 2.6.4 库存批次管理

库存以 **SKU + 生产日期** 为维度进行批次管理。每条库存记录（InventoryRecord）对应一个具体批次：

| 字段 | 说明 |
|------|------|
| 商品 | 关联的 SKU |
| 关联销售订单 | 该批次收货时关联的销售订单（可为空） |
| 批次号 | 系统自动生成（收货日期+采购单） |
| 生产日期 | 该批次的生产日期 |
| 总数量 | 该批次的入库总量 |
| 已预留数量 | 排柜确认时锁定的数量，防止重复分配 |
| 可用数量 | = 总数量 - 已预留数量，表示尚未被排柜计划占用的库存 |

**库存锁定机制：**
- 排柜计划**确认**时：`reserved_quantity += 分配数量`，`available_quantity -= 分配数量`
- 排柜计划**取消**时：释放预留，恢复可用数量
- 出库单**确认**时：`quantity -= 出库数量`，`reserved_quantity -= 出库数量`（真正扣减库存）

#### 2.6.5 库存视图

| 视图 | 说明 |
|------|------|
| 按商品汇总 | 每个 SKU 的总量、已预留量、可用量 |
| 按销售订单查看 | 每个销售订单需要哪些货、到了多少、还差多少 |
| 库存批次明细 | 逐批次展示：批次号、生产日期、总量、预留量、可用量、保质期剩余天数 |
| 待验货清单 | 到货但还没验货的记录 |
| 货物齐套检查 | 某个销售订单的所有货物是否已全部到齐并验收合格 |

#### 2.6.6 功能点

- **创建收货单**：选择采购单，系统自动带入待收货的商品和数量，仓库人员填写实收数量和验货结果
- **验货记录**：记录每次验货的结果、问题、照片（可选）
- **库存查询**：按商品汇总查看、按批次明细查看、按销售订单维度查看集货进度
- **批次库存列表**：供排柜配载时选择，显示每个批次的可用数量和保质期剩余天数
- **齐套提醒**：当某个销售订单的所有货物全部到齐且验收合格时，系统自动将销售订单状态更新为"已到齐"，并通知相关人员可以开始排柜

---

### 模块 7：排柜管理

#### 2.7.1 功能说明

第一期的**核心差异化模块**。管理从柜型选择、配载规划到实际装柜的全过程。系统自建配载计算能力，基于货物的外箱尺寸和重量数据，提供柜型推荐、利用率实时计算和超限告警。

#### 2.7.2 排柜计划状态流转

```
规划中 → 已确认 → 装柜中 → 已装柜 → 已出运
```

#### 2.7.3 排柜计划数据字段

**计划头信息：**

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| 排柜计划编号 | 字符串 | 是 | 系统自动生成，如 CL-20260226-001 |
| 关联销售订单 | 关联（多个） | 否 | 可选，一个柜可以合并多个订单；也可不选，直接按库存批次配载 |
| 柜型 | 枚举 | 是 | 20GP / 40GP / 40HQ / 冷藏柜 |
| 柜数量 | 数值 | 是 | 同柜型的柜子数量 |
| 目的港 | 字符串 | 条件必填 | 关联销售订单时自动取（合柜时需一致）；未关联时手动填写 |
| 计划状态 | 枚举 | 是 | |
| 备注 | 文本 | 否 | |

**柜型参考数据（系统内置）：**

| 柜型 | 内容积(CBM) | 最大载重(KG) | 内尺寸(cm) |
|------|------------|-------------|-----------|
| 20GP | 33.2 | 21,800 | 590 × 235 × 239 |
| 40GP | 67.7 | 26,680 | 1203 × 235 × 239 |
| 40HQ | 76.3 | 26,580 | 1203 × 235 × 269 |

**配载明细（每个柜子的装载内容）：**

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| 柜序号 | 数值 | 是 | 第几个柜子（如计划有2个40HQ，则有柜1、柜2） |
| 库存批次 | 关联 | 是 | 关联到 InventoryRecord，精确到 SKU + 生产日期 |
| 商品 | 关联 | 自动 | 从库存批次推导 |
| 来源销售订单 | 关联 | 自动 | 从库存批次推导（可为空） |
| 批次号 | 字符串 | 自动 | 从库存批次推导 |
| 生产日期 | 日期 | 自动 | 从库存批次推导 |
| 装柜数量 | 数值 | 是 | 不超过该批次的可用数量 |
| 占用体积(CBM) | 数值 | 自动 | 根据商品体积 × 数量计算 |
| 占用重量(KG) | 数值 | 自动 | 根据商品重量 × 数量计算 |

**柜子汇总（每个柜子自动计算）：**

| 字段 | 说明 |
|------|------|
| 已装体积(CBM) | 该柜所有商品的占用体积之和 |
| 体积利用率(%) | 已装体积 / 柜型内容积 × 100% |
| 已装重量(KG) | 该柜所有商品的占用重量之和 |
| 载重利用率(%) | 已装重量 / 柜型最大载重 × 100% |
| 是否超重 | 已装重量 > 最大载重时标红警告 |
| 是否超体积 | 已装体积 > 内容积时标红警告 |

#### 2.7.4 功能点

- **创建排柜计划**：可选关联销售订单（自动带入目的港），也可不关联直接创建（手动指定目的港）
- **按批次添加配载**：从库存批次列表中选择具体批次，指定数量分配到柜子。同一商品不同生产日期可混装同一柜，同一批次可部分分配
- **柜型推荐**：根据待装货物的总体积和总重量，自动推荐合适的柜型和柜数量（如 "建议 1 × 40HQ" 或 "建议 2 × 20GP"）
- **手动配载编辑**：将商品分配到具体的柜子中，实时显示每个柜子的体积/重量利用率
- **超限告警**：当某个柜子的体积或重量超过限制时，实时标红提醒，阻止确认
- **保质期校验**：根据商品生产日期 + 保质期 - 预估海运天数，计算到港后剩余保质期。如果剩余保质期不足总保质期的 2/3（可配置），给出黄色警告
- **确认排柜（锁定库存）**：确认排柜计划时，系统自动锁定（预留）涉及的库存批次，防止同一批次被重复分配到不同排柜计划
- **取消排柜（释放库存）**：取消已确认的排柜计划时，自动释放已锁定的库存，恢复可用数量
- **生成装箱单**：确认配载方案后，自动生成 Packing List（装箱单），包含每个柜子的详细装载明细
- **装柜记录**：
  - 记录实际装柜信息：柜号（集装箱号）、铅封号
  - 装柜日期、装柜地点
  - 装柜照片上传（支持多张）
  - 确认装柜完成
- **排柜看板**：全局视图，展示所有排柜计划的状态和进度

---

### 模块 8：基础物流跟踪

#### 2.8.1 功能说明

记录从订舱到客户收货的物流全过程。第一期实现手工录入跟踪，不对接外部系统。

#### 2.8.2 物流记录数据字段

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| 物流编号 | 字符串 | 是 | 系统自动生成 |
| 关联排柜计划 | 关联 | 是 | |
| 船公司 | 字符串 | 否 | |
| 船名航次 | 字符串 | 否 | |
| 提单号（B/L No.） | 字符串 | 否 | |
| 起运港 | 字符串 | 是 | |
| 目的港 | 字符串 | 自动 | 从排柜计划取 |
| 预计开船日（ETD） | 日期 | 否 | |
| 预计到港日（ETA） | 日期 | 否 | |
| 实际开船日 | 日期 | 否 | |
| 实际到港日 | 日期 | 否 | |
| 物流状态 | 枚举 | 是 | 已订舱 / 已报关 / 已装船 / 在途 / 已到港 / 已提柜 / 已签收 |
| 报关单号 | 字符串 | 否 | 手工录入，报关由外部处理 |
| 物流费用合计 | 数值 | 否 | |
| 备注 | 文本 | 否 | |

**费用明细行（可选录入）：**

| 字段 | 说明 |
|------|------|
| 费用类型 | 海运费 / 报关费 / 港杂费 / 拖车费 / 保险费 / 其他 |
| 金额 | |
| 币种 | RMB / USD |
| 备注 | |

#### 2.8.3 功能点

- **创建物流记录**：装柜完成后，创建物流记录，录入订舱和船期信息
- **更新物流状态**：手动更新物流节点状态（已报关 → 已装船 → 在途 → 已到港...）
- **物流费用录入**：按费用类型录入各项物流费用
- **物流看板**：全局视图展示所有在途货柜的状态

---

### 模块 9：出库管理

#### 2.9.1 功能说明

管理从排柜完成到正式出库的环节。排柜装柜完成后，通过创建出库单并确认，**真正扣减库存**并回写销售订单的已出库数量。出库单是库存扣减的唯一入口，确保库存账实相符。

#### 2.9.2 出库单状态流转

```
草稿 → 已确认
草稿 → 已取消
```

#### 2.9.3 出库单数据字段

**出库单头信息：**

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| 出库单编号 | 字符串 | 是 | 系统自动生成，如 OUT-20260228-001 |
| 关联排柜计划 | 关联 | 是 | 从已装柜(LOADED)的排柜计划创建 |
| 状态 | 枚举 | 是 | 草稿 / 已确认 / 已取消 |
| 出库日期 | 日期 | 确认时必填 | 实际出库日期 |
| 操作员 | 字符串 | 确认时必填 | 执行出库操作的人员 |
| 备注 | 文本 | 否 | |

**出库明细行（从排柜计划自动复制）：**

| 字段 | 类型 | 说明 |
|------|------|------|
| 库存批次 | 关联 | 关联到 InventoryRecord |
| 商品 | 关联 | 从库存批次推导 |
| 关联销售订单 | 关联 | 从库存批次推导（可为空） |
| 批次号 | 字符串 | |
| 生产日期 | 日期 | |
| 数量 | 数值 | 出库数量 |

#### 2.9.4 功能点

- **创建出库单**：从"已装柜"状态的排柜计划一键创建出库单草稿，自动复制配载明细为出库明细
- **防重复创建**：同一排柜计划只能创建一张出库单
- **确认出库**：填写出库日期和操作员后确认，系统自动执行：
  - 扣减库存：`quantity -= 出库数量`，`reserved_quantity -= 出库数量`
  - 回写销售订单：累加 `SalesOrderItem.outbound_quantity`
- **取消出库单**：仅草稿状态可取消，不影响库存
- **出库单列表**：按状态、关键词筛选，查看所有出库单

---

## 三、全局功能

### 3.1 首页仪表盘

| 区域 | 内容 |
|------|------|
| 订单概览 | 各状态的销售订单数量（饼图/数字卡片） |
| 待办事项 | 待确认的订单、待收货的采购单、已到齐待排柜的订单、即将到港的货柜 |
| 在途货柜 | 所有在途柜的状态列表 |
| 近期到期 | 保质期预警（如有库存货物） |

### 3.2 订单全程跟踪

在任意一个销售订单的详情页中，可以看到完整的履约链路：

```
销售订单 SO-xxx
  ├── 采购单 PO-001 → 供应商A → 收货单 RCV-001（已入库）
  ├── 采购单 PO-002 → 供应商B → 收货单 RCV-002（已入库）
  ├── 排柜计划 CL-001 → 40HQ × 1
  │     ├── 柜1：柜号 XXXX1234567 / 铅封号 YY123456
  │     └── 装箱单已生成
  └── 物流 LOG-001 → 船名 XXX → ETD: 2026-03-15 → 状态: 在途
```

### 3.3 搜索与筛选

- 全局搜索：输入订单号、客户名、商品名、柜号、提单号等，快速定位
- 列表页标准筛选：状态、日期范围、关联方

### 3.4 用户与权限

第一期采用分级角色模型，核心原则：**敏感数据的批量导出仅限超级管理员，各业务角色只能操作本职范围内的数据。**

#### 3.4.1 角色定义

| 角色 | 定位 | 人数预期 |
|------|------|---------|
| 超级管理员 | 系统最高权限，负责数据安全和系统配置 | 1-2 人 |
| 管理员 | 日常业务管理，可查看全部数据但不能批量导出 | 2-3 人 |
| 业务员 | 客户对接、下单、跟单 | 若干 |
| 采购员 | 供应商对接、采购执行 | 若干 |
| 仓库员 | 收货验货、装柜操作 | 若干 |
| 查看者 | 只读权限，用于管理层查阅 | 若干 |

#### 3.4.2 权限矩阵

**基础数据模块：**

| 操作 | 超级管理员 | 管理员 | 业务员 | 采购员 | 仓库员 | 查看者 |
|------|:---------:|:-----:|:-----:|:-----:|:-----:|:-----:|
| 商品 — 查看 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| 商品 — 新增/编辑 | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ |
| 商品 — 批量导入 | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ |
| 商品 — 批量导出 | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 客户 — 查看 | ✅ | ✅ | ✅ | ❌ | ❌ | ✅ |
| 客户 — 新增/编辑 | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ |
| 客户 — 批量导出 | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 供应商 — 查看 | ✅ | ✅ | ❌ | ✅ | ❌ | ✅ |
| 供应商 — 新增/编辑 | ✅ | ✅ | ❌ | ✅ | ❌ | ❌ |
| 供应商 — 批量导出 | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ |

**业务流程模块：**

| 操作 | 超级管理员 | 管理员 | 业务员 | 采购员 | 仓库员 | 查看者 |
|------|:---------:|:-----:|:-----:|:-----:|:-----:|:-----:|
| 销售订单 — 查看 | ✅ | ✅ | ✅ | ✅(关联的) | ✅(关联的) | ✅ |
| 销售订单 — 创建/编辑 | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ |
| 销售订单 — 确认 | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ |
| 销售订单 — 批量导出 | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 采购单 — 查看 | ✅ | ✅ | ✅(关联的) | ✅ | ❌ | ✅ |
| 采购单 — 创建/编辑 | ✅ | ✅ | ❌ | ✅ | ❌ | ❌ |
| 采购单 — 确认下单 | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ |
| 收货验货 — 操作 | ✅ | ✅ | ❌ | ❌ | ✅ | ❌ |
| 库存 — 查看 | ✅ | ✅ | ✅(关联的) | ✅(关联的) | ✅ | ✅ |
| 排柜 — 查看 | ✅ | ✅ | ✅ | ❌ | ✅ | ✅ |
| 排柜 — 创建/编辑 | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ |
| 排柜 — 确认方案 | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ |
| 装柜记录 — 操作 | ✅ | ✅ | ❌ | ❌ | ✅ | ❌ |
| 装箱单 — 导出 | ✅ | ✅ | ✅ | ❌ | ✅ | ❌ |
| 出库单 — 查看 | ✅ | ✅ | ✅ | ❌ | ✅ | ✅ |
| 出库单 — 创建/编辑 | ✅ | ✅ | ❌ | ❌ | ✅ | ❌ |
| 出库单 — 确认出库 | ✅ | ✅ | ❌ | ❌ | ✅ | ❌ |
| 物流 — 查看 | ✅ | ✅ | ✅ | ❌ | ❌ | ✅ |
| 物流 — 创建/更新 | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ |

**系统管理：**

| 操作 | 超级管理员 | 管理员 | 其他角色 |
|------|:---------:|:-----:|:-------:|
| 用户管理（增删改查） | ✅ | ❌ | ❌ |
| 角色分配 | ✅ | ❌ | ❌ |
| 品类管理（增删改查） | ✅ | ❌ | ❌ |
| 操作日志查看 | ✅ | ✅ | ❌ |
| 系统配置（保质期阈值等） | ✅ | ❌ | ❌ |
| 数据统计报表 | ✅ | ✅ | ❌ |

#### 3.4.3 敏感操作说明

| 敏感操作 | 允许角色 | 原因 |
|---------|---------|------|
| 批量导出商品数据 | 仅超级管理员 | 包含采购价等商业机密 |
| 批量导出客户数据 | 仅超级管理员 | 客户联系方式和付款信息属核心资产 |
| 批量导出供应商数据 | 仅超级管理员 | 供应商资质和价格信息属商业机密 |
| 批量导出订单数据 | 仅超级管理员 | 包含客户价格和交易明细 |
| 删除任何主数据 | 仅超级管理员 | 防止误删，普通角色只能停用 |
| 用户和权限管理 | 仅超级管理员 | 防止权限扩散 |

---

## 四、非功能性需求

### 4.1 技术要求

| 项目 | 要求 |
|------|------|
| 架构 | Web 应用，B/S 架构 |
| 前端 | 响应式设计，支持 PC 端浏览器访问；移动端优先适配仓库收货和装柜记录场景 |
| 后端 | RESTful API 设计 |
| 数据库 | 关系型数据库（PostgreSQL） |
| 部署 | Docker 容器化部署 |
| 并发 | 第一期支持 10 人以内同时在线 |

### 4.2 数据要求

| 项目 | 要求 |
|------|------|
| 数据备份 | 每日自动备份数据库 |
| 数据导出 | 关键列表页支持导出 Excel |
| 装箱单导出 | 支持导出为 Excel 和 PDF 格式 |

### 4.3 安全要求

| 项目 | 要求 |
|------|------|
| 登录认证 | 用户名 + 密码登录 |
| 权限控制 | 基于角色的分级访问控制（RBAC），详见 3.4 权限矩阵 |
| 数据隔离 | 批量导出接口仅对超级管理员开放，API 层强制校验角色 |
| 操作日志 | 关键操作（创建、修改、删除、导出、权限变更）记录操作人、时间和 IP |
| 导出审计 | 所有数据导出操作（含装箱单）记录导出人、时间、导出范围 |

---

## 五、核心业务规则

### 5.1 订单驱动规则

| 编号 | 规则 |
|------|------|
| R01 | 采购单可以关联销售订单，也可以独立创建 |
| R02 | 关联销售订单时，采购单明细的商品和数量不能超过关联销售订单的未采购需求 |
| R03 | 收货单必须关联采购单，实收数量不能超过采购单的未到货数量 |
| R04 | 排柜计划关联销售订单时，只能关联状态为"已到齐"的销售订单（不关联 SO 时跳过此校验） |
| R05 | 排柜配载按库存批次分配，分配数量不能超过该批次的可用数量（available_quantity） |

### 5.2 排柜校验规则

| 编号 | 规则 |
|------|------|
| R06 | 单柜装载体积不得超过柜型内容积，超出时阻止确认并标红告警 |
| R07 | 单柜装载重量不得超过柜型最大载重，超出时阻止确认并标红告警 |
| R08 | 合柜时目的港必须一致 |
| R09 | 保质期校验：到港剩余保质期不足总保质期 2/3 时黄色警告（阈值可配置） |

### 5.3 状态联动规则

| 编号 | 规则 |
|------|------|
| R10 | 销售订单确认后，状态自动变为"采购中" |
| R11 | 该订单所有采购单的货物全部入库验收合格后，订单状态自动变为"已到齐" |
| R12 | 排柜计划确认后，锁定相关库存批次（reserved_quantity += 分配数量）；当某个销售订单的所有商品均已被完全预留时，该订单状态自动变为"已排柜" |
| R13 | 装柜完成后（录入柜号+铅封号），关联的销售订单状态自动变为"已装柜" |
| R14 | 物流状态更新为"已装船"后，关联的销售订单状态自动变为"已出运" |
| R15 | 物流状态更新为"已签收"后，关联的销售订单状态自动变为"已签收" |

### 5.4 出库规则

| 编号 | 规则 |
|------|------|
| R16 | 出库单只能从"已装柜"状态的排柜计划创建，且同一排柜计划只能创建一张出库单 |
| R17 | 出库单确认时真正扣减库存（quantity -= 出库数量, reserved_quantity -= 出库数量），并回写销售订单已出库数量 |
| R18 | 取消排柜计划时，释放已锁定的库存预留（reserved_quantity -= 分配数量, available_quantity += 分配数量），计划回退到"规划中"状态 |

---

## 六、关键页面原型说明

### 6.1 首页仪表盘

```
┌────────────────────────────────────────────────────────────────┐
│  零食出口 ERP                                    [用户名] [退出] │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐          │
│  │ 待确认订单 │ │ 采购中    │ │ 已到齐    │ │ 在途货柜  │          │
│  │    3      │ │    5     │ │    2     │ │    4     │          │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘          │
│                                                                │
│  待办事项                          在途货柜                      │
│  ┌───────────────────────┐       ┌───────────────────────┐     │
│  │ ⚪ SO-001 待确认        │       │ CL-005 → Manila       │     │
│  │ ⚪ PO-012 供应商已发货   │       │   ETD: 03-10 在途      │     │
│  │ ⚪ SO-008 货物已到齐     │       │ CL-003 → Tokyo        │     │
│  │   可以开始排柜          │       │   ETA: 03-05 即将到港   │     │
│  └───────────────────────┘       └───────────────────────┘     │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

### 6.2 销售订单详情页

```
┌────────────────────────────────────────────────────────────────┐
│  销售订单 SO-20260226-001                     状态: [采购中]     │
├────────────────────────────────────────────────────────────────┤
│  客户: ABC Trading Co.    目的港: Manila, Philippines           │
│  订单日期: 2026-02-26     要求交期: 2026-03-20                   │
│  贸易术语: FOB            币种: USD                              │
│  采购完成率: ████████░░ 80%    到货完成率: ██████░░░░ 60%        │
├────────────────────────────────────────────────────────────────┤
│  商品明细                                                       │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ SKU      │ 商品名     │ 数量  │ 单价  │ 已采购 │ 已入库  │  │
│  │ SN-001   │ XX薯片     │ 500箱 │ $12  │ 500   │ 300    │  │
│  │ SN-002   │ XX饼干     │ 300箱 │ $15  │ 200   │ 200    │  │
│  │ SN-003   │ XX糖果     │ 200箱 │ $18  │ 200   │ 0      │  │
│  └──────────────────────────────────────────────────────────┘  │
├────────────────────────────────────────────────────────────────┤
│  履约链路                                                       │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 采购单                                                    │  │
│  │   PO-001 → 供应商A → 已到货                               │  │
│  │   PO-002 → 供应商B → 部分到货                              │  │
│  │                                                           │  │
│  │ 排柜计划                                                   │  │
│  │   (待货物到齐后排柜)                                        │  │
│  │                                                           │  │
│  │ 物流                                                       │  │
│  │   (待排柜完成)                                              │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────────────┘
```

### 6.3 排柜配载页面

```
┌────────────────────────────────────────────────────────────────┐
│  排柜计划 CL-20260226-001              状态: [规划中]            │
│  目的港: Manila    柜型: 40HQ × 1                               │
├─────────────────────────┬──────────────────────────────────────┤
│  待装货物（左侧）        │  柜子 #1 — 40HQ（右侧）               │
│  ┌─────────────────────┐│  ┌──────────────────────────────────┐│
│  │ SO-001 的货物:       ││  │ 已装载:                          ││
│  │  XX薯片 300箱        ││  │  XX薯片 300箱   (SO-001)        ││
│  │  XX饼干 200箱        ││  │  XX饼干 200箱   (SO-001)        ││
│  │  XX糖果 200箱        ││  │  XX糖果 200箱   (SO-001)        ││
│  │                     ││  │  YY坚果 150箱   (SO-002)        ││
│  │ SO-002 的货物:       ││  │                                  ││
│  │  YY坚果 150箱        ││  │──────────────────────────────── ││
│  │  YY果冻 100箱        ││  │ 体积: 52.3 / 76.3 CBM  [68.6%] ││
│  │                     ││  │ 重量: 18200 / 26580 KG  [68.5%] ││
│  │                     ││  │ ✅ 体积未超限  ✅ 重量未超限       ││
│  └─────────────────────┘│  └──────────────────────────────────┘│
│                         │                                      │
│ [柜型推荐]  [手动分配]    │  [确认方案]  [生成装箱单]              │
└─────────────────────────┴──────────────────────────────────────┘
```

---

## 七、数据统计（第一期简版）

第一期提供基础的统计查询能力，不做复杂 BI：

| 统计项 | 说明 |
|--------|------|
| 销售订单汇总 | 按月/按客户统计订单数量和金额 |
| 采购汇总 | 按月/按供应商统计采购金额 |
| 出柜统计 | 按月统计出柜数量、柜型分布 |
| 客户排名 | 按订单金额排名 |
| 商品排名 | 按销售数量排名 |

---

## 八、术语表

| 术语 | 英文 | 说明 |
|------|------|------|
| 排柜 | Container Loading Planning | 将货物合理分配到集装箱的规划过程 |
| 装柜 | Container Stuffing | 将货物实际装入集装箱的操作 |
| 以销定采 | Make-to-Order Procurement | 根据销售订单确定采购需求 |
| 集货 | Consolidation | 将多个供应商的货物按订单汇集到仓库 |
| 柜型 | Container Type | 集装箱类型（20GP/40GP/40HQ等） |
| CBM | Cubic Meter | 立方米，衡量货物体积 |
| FOB | Free On Board | 离岸价，卖方负责到装运港 |
| CIF | Cost, Insurance & Freight | 到岸价，卖方负责运费和保险 |
| CFR | Cost and Freight | 成本加运费，卖方负责运费但不含保险 |
| ETD | Estimated Time of Departure | 预计开船日 |
| ETA | Estimated Time of Arrival | 预计到港日 |
| B/L | Bill of Lading | 海运提单 |
| T/T | Telegraphic Transfer | 电汇 |
| L/C | Letter of Credit | 信用证 |
| D/P | Documents against Payment | 付款交单 |
| D/A | Documents against Acceptance | 承兑交单 |
| HS 编码 | Harmonized System Code | 海关商品分类编码 |
| SC | 食品生产许可证 | 国内食品生产企业必备资质 |
| 单一窗口 | China Single Window | 中国国际贸易单一窗口，报关报检在线平台 |

---

## 九、版本历史

| 版本 | 日期 | 变更说明 |
|------|------|---------|
| v1.0 | 2026-02-26 | 初版 PRD，覆盖 8 大模块 |
| v1.1 | 2026-02-28 | 商品品类从扁平枚举改为三级品类体系（一级→二级→三级），新增品类管理功能（系统管理菜单下），供应商供应品类改为从一级品类选择，权限矩阵新增品类管理权限 |
| v1.2 | 2026-02-28 | 库存升级为批次管理（SKU+生产日期），排柜从 SO 驱动改为库存批次驱动，排柜确认时锁定库存（预留），新增模块 9 出库管理（出库单确认时真正扣减库存），更新业务规则 R04/R05/R12 并新增 R16-R18，权限矩阵新增出库单权限 |
